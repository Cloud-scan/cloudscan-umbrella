{{- if and .Values.storage.enabled .Values.storage.migration.enabled }}
{{- $_ := set . "serviceName" "storage" }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "cloudscan.fullname" . }}-storage-migration
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cloudscan.service.labels" . | nindent 4 }}
    app.kubernetes.io/component: migration
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  backoffLimit: {{ .Values.storage.migration.backoffLimit | default 3 }}
  activeDeadlineSeconds: {{ .Values.storage.migration.activeDeadlineSeconds | default 600 }}
  template:
    metadata:
      labels:
        {{- include "cloudscan.service.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: migration
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      restartPolicy: Never
      securityContext:
        {{- include "cloudscan.podSecurityContext" . | nindent 8 }}
      containers:
      - name: liquibase
        image: {{ printf "%s/%s-liquibase:%s" (.Values.storage.image.registry | default .Values.global.imageRegistry | default "docker.io") .Values.storage.image.repository (.Values.storage.migration.imageTag | default .Values.storage.image.tag | default "latest") }}
        imagePullPolicy: {{ .Values.storage.image.pullPolicy | default .Values.global.imagePullPolicy | default "IfNotPresent" }}
        securityContext:
          {{- include "cloudscan.containerSecurityContext" . | nindent 10 }}
        env:
        # PostgreSQL connection
        - name: POSTGRES_HOST
          value: {{ include "cloudscan.postgres.host" . | quote }}
        - name: POSTGRES_PORT
          value: {{ .Values.global.postgres.port | default "5432" | quote }}
        - name: POSTGRES_USER
          value: {{ .Values.global.postgres.user | default "cloudscan" | quote }}
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "cloudscan.postgres.secretName" . }}
              key: password
        - name: POSTGRES_DATABASE
          value: {{ .Values.storage.postgres.database | default "storage" | quote }}
        - name: POSTGRES_SSLMODE
          value: {{ .Values.global.postgres.sslmode | default "disable" | quote }}
        - name: CREATE_DATABASE
          value: {{ .Values.storage.migration.createDatabase | default "true" | quote }}
        - name: LIQUIBASE_LOG_LEVEL
          value: {{ .Values.storage.migration.logLevel | default "INFO" | quote }}
        command:
          - /bin/sh
          - -c
          - |
            set -e

            if [ "$CREATE_DATABASE" = "true" ]; then
              echo "Checking if database $POSTGRES_DATABASE exists..."
              export PGHOST=$POSTGRES_HOST
              export PGPORT=$POSTGRES_PORT
              export PGUSER=$POSTGRES_USER
              export PGPASSWORD=$POSTGRES_PASSWORD

              # Connect to default postgres database to check/create our database
              RecordCount=$(psql -d postgres -t -c "SELECT count(*) FROM pg_database WHERE datname='$POSTGRES_DATABASE'")
              if [ "$RecordCount" -eq 0 ]; then
                echo "Creating database $POSTGRES_DATABASE..."
                psql -d postgres -c "CREATE DATABASE $POSTGRES_DATABASE ENCODING 'UTF8'"
                echo "Database $POSTGRES_DATABASE created successfully"
              else
                echo "Database $POSTGRES_DATABASE already exists"
              fi
            fi

            echo "Running Liquibase migrations..."
            /liquibase/liquibase \
              --changelog-file=changelog/db.changelog-master.xml \
              --url=jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DATABASE}?sslmode=${POSTGRES_SSLMODE} \
              --username=${POSTGRES_USER} \
              --password=${POSTGRES_PASSWORD} \
              --log-level=${LIQUIBASE_LOG_LEVEL} \
              update
        resources:
          {{- toYaml .Values.storage.migration.resources | nindent 10 }}
      {{- with .Values.storage.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.storage.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.storage.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
