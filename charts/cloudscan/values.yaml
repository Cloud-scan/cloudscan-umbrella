# CloudScan Helm Chart - Default Values
# See https://helm.sh/docs/chart_template_guide/subcharts_and_globals/#global-chart-values

## =============================================================================
## Global settings - shared across all services
## =============================================================================
global:
  # Image registry for all CloudScan services
  imageRegistry: "docker.io"

  # Image pull policy for all pods
  # Allowed values: Always, IfNotPresent, Never
  imagePullPolicy: IfNotPresent

  # Image pull secrets (if registry requires authentication)
  imagePullSecrets: []
  # Example:
  #  - name: cloudscan-registry-secret

  # Common image tag used for all CloudScan services
  # This can be overridden per service
  imageVersion: "latest"

  # Environment name: development, staging, production
  environment: "production"

  # Log level: debug, info, warn, error
  logLevel: "info"

  # Kubernetes storage class for persistent volumes
  storageClass: ""

  # Node selector for all pods (can be overridden per service)
  nodeSelector: {}

  # Tolerations for all pods (can be overridden per service)
  tolerations: []

  # PostgreSQL shared configuration
  # All services will use these settings unless overridden
  postgres:
    # PostgreSQL host (leave empty to use onPrem postgresql)
    host: ""
    # PostgreSQL port
    port: 5432
    # PostgreSQL user
    user: "cloudscan"
    # PostgreSQL password (should be overridden or use existingSecret)
    password: "changeme"
    # SSL mode: disable, allow, prefer, require, verify-ca, verify-full
    sslmode: "disable"
    # Use existing Kubernetes secret for credentials
    # Secret must have keys: host, port, username, password
    existingSecret: ""

  # Redis shared configuration
  redis:
    # Redis host (leave empty to use onPrem redis)
    host: ""
    # Redis port
    port: 6379
    # Enable authentication
    authEnabled: true
    # Redis password (should be overridden or use passwordSecret)
    password: "redis123"
    # Secret containing Redis password (key: password)
    passwordSecret: ""
    # Enable TLS for Redis communication
    secure: false
    # Verify hostname for TLS
    verifyHostName: false
    # CA cert secret for TLS (key: ca.crt)
    cacertSecret: ""

  # MinIO/S3 shared configuration
  storage:
    # Storage type: s3, minio, gcs, azure, local
    type: "minio"
    # S3/MinIO configuration
    s3:
      # S3 endpoint (hostname:port only - NO http:// or https://)
      # Leave empty for AWS S3, set to "hostname:port" for MinIO
      # Example: "cloudscan-minio:9000" or "minio.example.com:9000"
      endpoint: ""
      # S3 bucket name
      bucket: "cloudscan-artifacts"
      # S3 region
      region: "us-east-1"
      # Access key
      accessKey: ""
      # Secret key
      secretKey: ""
      # Use existing secret (keys: accessKey, secretKey)
      existingSecret: ""
      # Use SSL/TLS for S3 connections
      useSSL: false
    # GCS configuration
    gcs:
      bucket: ""
      projectId: ""
      # Secret with GCS credentials JSON (key: credentials.json)
      credentialsSecret: ""
    # Azure Blob configuration
    azure:
      accountName: ""
      container: ""
      accountKey: ""
      # Secret with Azure credentials (key: accountKey)
      existingSecret: ""

  # Ingress configuration (applies to all services)
  ingress:
    # Enable ingress
    enabled: false
    # Ingress class name
    className: "nginx"
    # Ingress annotations
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    # Ingress hosts
    hosts:
      - host: cloudscan.local
        paths:
          - path: /
            pathType: Prefix
            service: ui
            port: 8080
          - path: /api
            pathType: Prefix
            service: apigateway
            port: 8080
          - path: /ws
            pathType: Prefix
            service: websocket
            port: 9090
    # TLS configuration
    tls: []
    # Example:
    # - secretName: cloudscan-tls
    #   hosts:
    #     - cloudscan.local

## =============================================================================
## On-Premise Dependencies - Control which charts to deploy
## =============================================================================
onPrem:
  # Deploy Bitnami PostgreSQL chart
  postgresql: true

  # Deploy Bitnami Redis chart
  redis: true

  # Deploy Bitnami MinIO chart
  minio: true

## =============================================================================
## PostgreSQL (Bitnami Chart) - Only deployed if onPrem.postgresql=true
## =============================================================================
postgresql:
  # PostgreSQL version
  image:
    tag: "16.6.0-debian-12-r3"

  # Authentication
  auth:
    # PostgreSQL admin username
    username: "cloudscan"
    # PostgreSQL admin password (override in production!)
    password: "changeme"
    # Default database
    database: "cloudscan"
    # Enable PostgreSQL admin user
    enablePostgresUser: true
    # Postgres admin password
    postgresPassword: "postgres"

  # Primary configuration
  primary:
    # Persistence configuration
    persistence:
      enabled: true
      size: 50Gi
      # storageClass: ""

    # Resource requests and limits
    resources:
      requests:
        cpu: 250m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi

    # PostgreSQL configuration
    # initdb:
    #   scripts:
    #     init.sql: |
    #       CREATE DATABASE orchestrator;
    #       CREATE DATABASE ui_backend;

## =============================================================================
## Redis (Bitnami Chart) - Only deployed if onPrem.redis=true
## =============================================================================
redis:
  # Redis architecture: standalone or replication
  architecture: standalone

  # Redis Bitnami Legacy images - Aug 22nd, 2025
  image:
    registry: registry-1.docker.io
    repository: bitnamilegacy/redis
    tag: "8.2.1-debian-12-r0"

  # Redis Sentinel - Aug 19th, 2025
  sentinel:
    image:
      registry: registry-1.docker.io
      repository: bitnamilegacy/redis-sentinel
      tag: "8.2.1-debian-12-r0"

  # Redis Exporter for metrics - Aug 24th, 2025
  metrics:
    enabled: true
    image:
      registry: registry-1.docker.io
      repository: bitnamilegacy/redis-exporter
      tag: "1.76.0-debian-12-r0"

  # Volume Permissions - Aug 19th, 2025
  volumePermissions:
    image:
      registry: registry-1.docker.io
      repository: bitnamilegacy/os-shell
      tag: "12-debian-12-r51"

  # Authentication
  auth:
    enabled: true
    password: "redis123"

  # Master configuration
  master:
    persistence:
      enabled: false

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 1Gi

  # Redis configuration
  commonConfiguration: |-
    # Save disabled for cache-only use
    save ""
    appendonly no
    # Max memory and eviction policy
    maxmemory 512mb
    maxmemory-policy allkeys-lru

## =============================================================================
## MinIO (Bitnami Chart) - Only deployed if onPrem.minio=true
## =============================================================================
minio:
  # MinIO mode: standalone or distributed
  mode: standalone

  # MinIO Server - July 23rd, 2025 (Bitnami Legacy)
  image:
    registry: registry-1.docker.io
    repository: bitnamilegacy/minio
    tag: "2025.7.23-debian-12-r3"

  # MinIO Client - July 21st, 2025 (Bitnami Legacy)
  clientImage:
    registry: registry-1.docker.io
    repository: bitnamilegacy/minio-client
    tag: "2025.7.21-debian-12-r2"

  # Default Init Containers Volume Permissions
  defaultInitContainers:
    volumePermissions:
      image:
        registry: registry-1.docker.io
        repository: bitnamilegacy/os-shell
        tag: "12-debian-12-r51"

  # Console/Gateway Image
  console:
    image:
      registry: registry-1.docker.io
      repository: bitnamilegacy/minio-object-browser
      tag: "2.0.2-debian-12-r3"

  # Authentication
  auth:
    rootUser: "admin"
    rootPassword: "changeme123"

  # Default buckets to create
  defaultBuckets: "cloudscan-artifacts"

  # Persistence
  persistence:
    enabled: true
    size: 100Gi

  # Resources
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  # Ingress for MinIO console
  ingress:
    enabled: false
    hostname: minio.local
    ingressClassName: nginx

## =============================================================================
## CloudScan Orchestrator Service
## =============================================================================
orchestrator:
  # Enable orchestrator deployment
  enabled: true

  # Number of replicas
  replicaCount: 2

  # Image configuration
  image:
    repository: "cloudscan-orchestrator"
    tag: ""  # Defaults to global.imageVersion
    pullPolicy: ""  # Defaults to global.imagePullPolicy

  # Service configuration
  service:
    type: ClusterIP
    # gRPC port
    grpcPort: 9999
    # HTTP port
    httpPort: 8081
    # Metrics port
    metricsPort: 9090
    annotations: {}

  # Resource requests and limits
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi

  # Database configuration (overrides global)
  postgres:
    # Database name for orchestrator
    database: "orchestrator"
    # Connection pool settings
    maxConns: 25
    minConns: 5
    # These inherit from global.postgres unless overridden:
    # host: ""
    # port: 5432
    # user: ""
    # password: ""
    # sslmode: ""
    # existingSecret: ""

  # Database migration configuration (Liquibase)
  migration:
    enabled: true
    imageTag: ""  # Defaults to orchestrator.image.tag
    logLevel: "INFO"
    backoffLimit: 3
    activeDeadlineSeconds: 600
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

  # Environment variables
  env: []
  # Example:
  # - name: LOG_LEVEL
  #   value: "info"
  # - name: GRPC_PORT
  #   value: "9999"

  # Additional environment variables from secrets/configmaps
  envFrom: []

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}

  # Pod annotations
  podAnnotations: {}

  # Security context
  podSecurityContext: {}
  containerSecurityContext: {}

  # Service account
  serviceAccount:
    create: true
    name: "cloudscan-orchestrator"
    annotations: {}

  # RBAC for creating Kubernetes Jobs
  rbac:
    create: true
    # ClusterRole rules for job management
    rules:
      - apiGroups: ["batch"]
        resources: ["jobs"]
        verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
      - apiGroups: [""]
        resources: ["pods", "pods/log"]
        verbs: ["get", "list", "watch"]

## =============================================================================
## CloudScan API Gateway
## =============================================================================
apiGateway:
  enabled: true
  replicaCount: 2

  image:
    repository: "cloudscan-api-gateway"
    tag: ""
    pullPolicy: ""

  service:
    type: ClusterIP
    port: 8080
    annotations: {}

  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  # JWT configuration
  jwt:
    secret: "changeme-jwt-secret-key"
    # Use existing secret (key: jwt-secret)
    existingSecret: ""
    expirationHours: 24

  # Rate limiting
  rateLimit:
    enabled: true
    requestsPerMinute: 60

  # gRPC client configuration
  grpc:
    orchestratorTimeout: "30s"
    orchestratorTLS: false
    storageTimeout: "30s"
    storageTLS: false

  # CORS configuration
  cors:
    allowedOrigins: "*"
    allowedMethods: "GET,POST,PUT,DELETE,OPTIONS"
    allowedHeaders: "Origin,Content-Type,Accept,Authorization"

  # Database configuration (overrides global)
  postgres:
    # Database name for api gateway
    database: "cloudscan_gateway"
    # Connection pool settings
    maxConns: 25
    minConns: 5

  # Database migration configuration (Liquibase)
  migration:
    enabled: true
    imageTag: ""  # Defaults to apiGateway.image.tag
    logLevel: "INFO"
    backoffLimit: 3
    activeDeadlineSeconds: 600
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

  env: []
  # Example environment variables:
  # - name: ORCHESTRATOR_GRPC_URL
  #   value: "{{ .Release.Name }}-cloudscan-orchestrator:9999"
  # - name: STORAGE_GRPC_URL
  #   value: "{{ .Release.Name }}-cloudscan-storage:9998"
  envFrom: []
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}
  podSecurityContext: {}
  containerSecurityContext: {}

## =============================================================================
## CloudScan Storage Service
## =============================================================================
storage:
  enabled: true
  replicaCount: 2

  image:
    repository: "cloudscan-storage"
    tag: ""
    pullPolicy: ""

  service:
    type: ClusterIP
    # gRPC port
    grpcPort: 9998
    # HTTP port
    httpPort: 8082
    # Deprecated: use httpPort instead
    port: 8082
    annotations: {}

  # Persistence configuration (only used when storageType is "local")
  persistence:
    enabled: false
    storageClass: ""
    size: 10Gi

  # Storage type configuration (inherits from global.storage.type)
  # Options: s3, minio, gcs, azure, local
  storageType: ""

  # Default expiration time for presigned URLs (in hours)
  defaultExpirationHours: 24

  # Database configuration (overrides global)
  postgres:
    # Database name for storage
    database: "storage"
    # Connection pool settings
    maxConns: 25
    minConns: 5

  # Database migration configuration (Liquibase)
  migration:
    enabled: true
    imageTag: ""  # Defaults to storage.image.tag
    logLevel: "INFO"
    backoffLimit: 3
    activeDeadlineSeconds: 600
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  env: []
  envFrom: []
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}
  podSecurityContext: {}
  containerSecurityContext: {}

## =============================================================================
## CloudScan WebSocket Service
## =============================================================================
websocket:
  enabled: true
  replicaCount: 2

  image:
    repository: "cloudscan-websocket"
    tag: ""
    pullPolicy: ""

  service:
    type: ClusterIP
    port: 9090
    httpPort: 8083
    annotations: {}

  # CORS configuration
  cors:
    allowedOrigins: "*"

  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  env: []
  envFrom: []
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}
  podSecurityContext: {}
  containerSecurityContext: {}

## =============================================================================
## CloudScan UI Service (Spring Boot + React)
## =============================================================================
ui:
  enabled: true
  replicaCount: 2

  image:
    repository: "cloudscan-ui"
    tag: ""
    pullPolicy: ""

  service:
    type: ClusterIP
    # Spring Boot backend port
    port: 8080
    annotations: {}

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 2Gi

  # Database configuration for UI backend (Spring Boot)
  postgres:
    database: "ui_backend"

  # Frontend runtime configuration (for React app)
  frontend:
    # API URL (relative or absolute)
    apiUrl: "/api"
    # WebSocket URL (relative or absolute)
    wsUrl: "/ws"

  # Note: UI does not require database migrations as it's a static SPA

  env: []
  envFrom: []
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}
  podSecurityContext: {}
  containerSecurityContext: {}

## =============================================================================
## CloudScan Runner (K8s Job Template)
## =============================================================================
runner:
  # Enable runner (controls whether job templates are created)
  enabled: true

  image:
    repository: "cloudscan-runner"
    tag: ""
    pullPolicy: ""

  # Resource requests and limits for scan jobs
  resources:
    requests:
      cpu: 2000m
      memory: 4Gi
    limits:
      cpu: 4000m
      memory: 8Gi

  # Job configuration
  job:
    # Time to retain completed jobs
    ttlSecondsAfterFinished: 3600  # 1 hour
    # Backoff limit for failed jobs
    backoffLimit: 1
    # Active deadline seconds
    activeDeadlineSeconds: 3600  # 1 hour timeout

  # Scanner configuration
  scanners:
    # SAST - Semgrep
    semgrep:
      enabled: true
    # SCA - Trivy
    trivy:
      enabled: true
      # Trivy DB updates
      dbUpdateEnabled: true
    # Secrets - TruffleHog
    trufflehog:
      enabled: true
      # Verify secrets (makes external API calls)
      verify: false
    # License - ScanCode
    scancode:
      enabled: true

  env: []
  envFrom: []
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podAnnotations: {}
  podSecurityContext: {}
  containerSecurityContext: {}

  # Service account for runners
  serviceAccount:
    create: true
    name: "cloudscan-runner"
    annotations: {}

## =============================================================================
## ServiceAccount (Global)
## =============================================================================
serviceAccount:
  # Create a service account
  create: true
  # Service account name
  name: ""
  # Annotations
  annotations: {}

## =============================================================================
## RBAC (Global)
## =============================================================================
rbac:
  # Create RBAC resources
  create: true

## =============================================================================
## Ingress Configuration
## =============================================================================
ingress:
  # Enable ingress
  enabled: false
  # Ingress class name
  className: "nginx"
  # Ingress annotations
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
  # Ingress hosts
  hosts:
    - host: cloudscan.local
      paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: ""  # Uses default service name
              port: 8080
        - path: /api
          pathType: Prefix
          backend:
            service:
              name: ""  # Uses apigateway service
              port: 8080
        - path: /ws
          pathType: Prefix
          backend:
            service:
              name: ""  # Uses websocket service
              port: 9090
  # TLS configuration
  tls: []
  # Example:
  # - secretName: cloudscan-tls
  #   hosts:
  #     - cloudscan.local

## =============================================================================
## Monitoring & Observability
## =============================================================================
monitoring:
  # Enable Prometheus metrics
  enabled: true

  # ServiceMonitor (requires Prometheus Operator)
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s

  # Grafana dashboards
  grafana:
    enabled: false
    # Dashboard ConfigMaps
    dashboards: {}